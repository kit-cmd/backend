name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

env:
  DOCKER_IMAGE: ghcr.io/${{ github.actor }}/trading
  VERSION: ${{ github.sha }}
  NAME: go_cicd
  REDIS_HOST: localhost
  REDIS_PORT: 6379
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
  DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  CORS_ALLOWED_ORIGINS: http://localhost:3000
  CORS_ALLOWED_METHODS: GET,POST,UPDATE
  CORS_ALLOWED_HEADERS: "*"
  CORS_ALLOW_CREDENTIALS: "true"

jobs:
  build:
    name: CI
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'zulu'
      - name: Make application.properties
        run: |
         cd ./src/main/resources
         touch ./application.properties
         echo "${{ secrets.PROPERTIES }}" > ./application.properties
        shell: bash
       
      - name: Build with Gradle
        run: |
             chmod +x ./gradlew
             ./gradlew clean build -x test
             
      - name: Docker build & push to docker repo
        run: |
             docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
             docker build -f Dockerfile -t ${{ secrets.DOCKER_REPO }}/directors-dev .
             docker push ${{ secrets.DOCKER_REPO }}/directors-dev

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        id: deploy
        with:
          host: ${{ secrets.HOST }}
          username: ubuntu
          key: ${{ secrets.KEY }}
          envs: GITHUB_SHA
          script: |
                sudo docker rm -f $(docker ps -qa)
                sudo docker pull ${{ secrets.DOCKER_REPO }}/directors-dev
                docker-compose up -d
                docker image prune -f
  
